---
title: "Post-Disaster Demographic Changes"
author: "Matt Khinda, Jeb Polstein, Slide Kelly"
date: "10/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
### Research Question  

How well do demographic factors predict post-hurricane Sandy displacement? Which factors are most strongly correlated with displacement?  

### Prior Research  

Faber (2015) finds that flood risk in New York City during Hurricane Sandy varied by race and poverty. Black people were more likely than those of other races to live in areas that flooded, Latinx people were less likely to live in areas that flooded, and poverty rates were higher in areas that flooded than those that did not. Fussell and Harris (2014), studying displacement in New Orleans after Hurricane Katrina, find that renters were more likely to be displaced than homeowners. 


### Data Sources  

Our dataset will include the following American Community Survey 5-year estimate variables for years ending in 2011-2016:

Geographic Mobility by Age (Continuous variable - ACS: B07001)  
Geographic Mobility by Race (Continuous variable - ACS: B07004A, B07004B, B07004C, B07004D, B07004E)  
Geographic Mobility by Hispanic / Non-Hispanic (Continuous variable - ACS: B07004I)  
Geographic Mobility by Income (Continuous Variable - ACS: B07010)  
Geographic Mobility by Housing Tenure (Continuous - ACS: B07013)  
Median Monthly Gross Rent (Continuous - ACS: B25064_001)  
Median Selected Monthly Owner Costs (Continuous - ACS: B25088_001)  
County (Categorical - ACS)  
Location in 100-year Floodplain (Categorical - FEMA flood maps)*  
Flooded in Superstorm Sandy (Categorical - TBD)*  
  
*Floodplain location data and Sandy flooding data has not yet been worked out, though the anticipated workflow is to import a shapefile and use st_intersects() with the census tracts to return a Boolean True/False variable. Shapefiles are expected to be pulled from FEMA flood maps. Superstorm Sandy data has been hard to find, but we found one dataset from NYC at https://data.cityofnewyork.us/Environment/Sandy-Inundation-Zone/uyj8-7rv5 and are hoping to find others by state or county. Any advice or help on this workflow would be appreciated.

The sample population is people in all census tracts within the following counties, which were highly affected by Sandy:

Ocean (NJ), Monmouth (NJ), Middlesex (NJ), Union (NJ), Essex (NJ), Hudson (NJ), Bergen (NJ), Westchester (NY), Rockland (NY), Bronx (NY), New York (NY), Kings (NY), Queens (NY), Richmond (NY), Nassau (NY), Suffolk (NY), Fairfield (CT), New Haven (CT)

## Load Data  
```{r load packages, results = 'hide', message=FALSE}
library(tidyverse)
library(tidycensus)
library(readxl)
library(knitr)
library(ggplot2)
library(sf)
library(ggspatial)
library(here)
library(stringr)
```

```{r explore ACS data, include=FALSE}
#only used for browsing acs data variables and finding codes
v11 <- load_variables(2011, "acs5", cache = TRUE)
View(v11)

```

```{r load ACS data, results = 'hide', message=FALSE}
#load NY 2011 data
ny_acs_2011 <- get_acs(geography = "tract", 
                       county = c("Queens", 
                                  "Westchester", 
                                  "Rockland", 
                                  "Richmond", 
                                  "Bronx", 
                                  "New York", 
                                  "Kings", 
                                  "Nassau",
                                  "Suffolk"), 
                        state = "NY",
                        year = 2011, survey = "acs5",
                        variables = c(
                             total_pop_2011 = "B01003_001",

                             black_pop_2011 = "B02001_003",
                             white_pop_2011 = "B02001_002",
                             native_pop_2011 = "B02001_004",
                             asian_pop_2011 = "B02001_005",
                             hawaiian_pop_2011 = "B02001_006",
                             hispanic_pop_2011 = "B03001_003",
                             
                             med_income_2011 = "B19013_001",
                             med_propvalue_2011 = "B25077_001",
                             tot_renter_2011 = "B25003_003"),
                        output = "wide", geometry = TRUE)

#load NY 2013 data
ny_acs_2013 <- get_acs(geography = "tract", 
                       county = c("Queens", 
                                  "Westchester", 
                                  "Rockland", 
                                  "Richmond", 
                                  "Bronx", 
                                  "New York", 
                                  "Kings", 
                                  "Nassau",
                                  "Suffolk"), 
                        state = "NY",
                        year = 2013, survey = "acs5",
                        variables = c(
                             total_pop_2013 = "B01003_001"),
                        output = "wide", geometry = TRUE)

ny_acs_2013 <- ny_acs_2013 %>%
  st_set_geometry(NULL)

full_ny <- merge(x = ny_acs_2011, y = ny_acs_2013)


#load NJ 2011 data
nj_acs_2011 <- get_acs(geography = "tract", 
                       county = c("Ocean", 
                                  "Union", 
                                  "Essex", 
                                  "Bergen", 
                                  "Hudson", 
                                  "Middlesex", 
                                  "Monmouth"), 
                        state = "NJ",
                        year = 2011, survey = "acs5",
                         variables = c(
                             total_pop_2011 = "B01003_001",

                             black_pop_2011 = "B02001_003",
                             white_pop_2011 = "B02001_002",
                             native_pop_2011 = "B02001_004",
                             asian_pop_2011 = "B02001_005",
                             hawaiian_pop_2011 = "B02001_006",
                             hispanic_pop_2011 = "B03001_003",
                             
                             med_income_2011 = "B19013_001",
                             med_propvalue_2011 = "B25077_001",
                             tot_renter_2011 = "B25003_003"),
                        output = "wide", geometry = TRUE)

#load NJ 2013 data
nj_acs_2013 <- get_acs(geography = "tract", 
                       county = c("Ocean", 
                                  "Union", 
                                  "Essex", 
                                  "Bergen", 
                                  "Hudson", 
                                  "Middlesex", 
                                  "Monmouth"), 
                        state = "NJ",
                        year = 2013, survey = "acs5",
                         variables = c(
                             total_pop_2013 = "B01003_001"),
                        output = "wide", geometry = TRUE)

nj_acs_2013 <- nj_acs_2013 %>%
  st_set_geometry(NULL)

full_nj <- merge(x = nj_acs_2011, y = nj_acs_2013)


#load CT 2011 data
ct_acs_2011 <- get_acs(geography = "tract", 
                       county = c("New Haven", 
                                  "Fairfield"), 
                        state = "CT",
                        year = 2011, survey = "acs5",
                        variables = c(
                             total_pop_2011 = "B01003_001",

                             black_pop_2011 = "B02001_003",
                             white_pop_2011 = "B02001_002",
                             native_pop_2011 = "B02001_004",
                             asian_pop_2011 = "B02001_005",
                             hawaiian_pop_2011 = "B02001_006",
                             hispanic_pop_2011 = "B03001_003",
                             
                             med_income_2011 = "B19013_001",
                             med_propvalue_2011 = "B25077_001",
                             tot_renter_2011 = "B25003_003"),
                        output = "wide", geometry = TRUE)


#load CT 2013 data
ct_acs_2013 <- get_acs(geography = "tract", 
                       county = c("New Haven", 
                                  "Fairfield"), 
                        state = "CT",
                        year = 2013, survey = "acs5",
                        variables = c(
                             total_pop_2013 = "B01003_001"),
                        output = "wide", geometry = TRUE)

ct_acs_2013 <- ct_acs_2013 %>%
  st_set_geometry(NULL)

full_ct <- merge(x = ct_acs_2011, y = ct_acs_2013)


#combine all data
full_acs <- rbind(full_ny,full_nj,full_ct)

#filter out tracts with 0 population
full_acs <- full_acs %>%
  filter(total_pop_2011E != 0)

#create new variables
full_acs <- full_acs %>%
  mutate(county = sapply(strsplit(NAME,", "), `[`, 2)) %>%
  mutate(pct_pop_changeE = round(((total_pop_2013E - total_pop_2011E)/total_pop_2011E)*100, 2)) %>%
  mutate(pct_black_pop_2011E = round((black_pop_2011E/total_pop_2011E)*100, 2)) %>%
  mutate(pct_white_pop_2011E = round((white_pop_2011E/total_pop_2011E)*100, 2)) %>%
  mutate(pct_native_pop_2011E = round((native_pop_2011E/total_pop_2011E)*100, 2)) %>%
  mutate(pct_asian_pop_2011E = round((asian_pop_2011E/total_pop_2011E)*100, 2)) %>%
  mutate(pct_hawaiian_pop_2011E = round((hawaiian_pop_2011E/total_pop_2011E)*100, 2)) %>%
  mutate(pct_hispanic_pop_2011E = round((hispanic_pop_2011E/total_pop_2011E)*100, 2)) %>%
  mutate(pct_renter_2011E = round((tot_renter_2011E/total_pop_2011E)*100, 2)) %>%
  mutate(tract_area = st_area(geometry)) %>%
  mutate(pop_density_2011E = round((total_pop_2011E/tract_area)*100, 2))

#read in election data
ourstates <- c("NY", "NJ", "CT")
ourcounties <- c( "Queens", 
                  "Westchester", 
                  "Rockland", 
                  "Richmond", 
                  "Bronx", 
                  "New York", 
                  "Kings", 
                  "Nassau",
                  "Suffolk",
                  "Ocean", 
                  "Union", 
                  "Essex", 
                  "Bergen", 
                  "Hudson", 
                  "Middlesex", 
                  "Monmouth",
                  "New Haven", 
                  "Fairfield")

election <- read_csv(here("Data", "countypres_2000-2020.csv")) %>%
  filter(state_po %in% ourstates) %>%
  mutate(county_name = str_to_title(county_name)) %>%
  filter(county_name %in% ourcounties) %>%
  filter(year == 2008) %>%
  filter(party == "REPUBLICAN") %>%
  rename(GEOID = county_name) %>%
  group_by(GEOID) %>%
  summarize(candidatevotes = sum(candidatevotes),
            totalvotes = first(totalvotes)) %>%
  mutate(pct_GOP = candidatevotes / totalvotes) %>%
  mutate(majority_vote = ifelse(pct_GOP > 0.5, "Republican", "Democrat")) %>%
  select(GEOID, pct_GOP, majority_vote) %>%
  mutate(addcounty = "County") %>%
  mutate(county_name = paste(GEOID, addcounty, sep = " ")) %>%
  select(county_name, majority_vote)

#adding election data to full acs
full_acs <- merge(full_acs, election, by.x = "county", by.y = "county_name")
  


```

```{r plot, include = FALSE}
#plot to test that correct counties are coming through
ggplot(full_acs)+
  annotation_map_tile(zoomin = 0, progress = "none", type = "cartolight") +
  geom_sf(aes(fill = majority_vote), color = "black")+
  scale_fill_manual(values = c("blue", "red"))+
  theme_void()
```

```{r}
kable(head(full_acs))
```

The dataset includes 4515 census tracts.

### DESCRIPTIVE STATISTICS

```{r}
pct_pop_change_t_test <- t.test(full_acs$pct_pop_changeE)
pct_black_pop_2011_t_test <- t.test(full_acs$pct_black_pop_2011E)
pct_white_pop_2011_t_test <- t.test(full_acs$pct_white_pop_2011E)
pct_asian_pop_2011_t_test <- t.test(full_acs$pct_asian_pop_2011E)
pct_hispanic_pop_2011_t_test <- t.test(full_acs$pct_hispanic_pop_2011E)
pct_renter_2011_t_test <- t.test(full_acs$pct_renter_2011E)
med_income_2011_t_test <- t.test(full_acs$med_income_2011E)
```

```{r}
pct_pop_change_quartiles <- quantile(full_acs$pct_pop_changeE, na.rm = TRUE)
pct_black_pop_2011_quartiles <- quantile(full_acs$pct_black_pop_2011E, na.rm = TRUE)
pct_white_pop_2011_quartiles <- quantile(full_acs$pct_white_pop_2011E, na.rm = TRUE)
pct_asian_pop_2011_quartiles <- quantile(full_acs$pct_asian_pop_2011E, na.rm = TRUE)
pct_hispanic_pop_2011_quartiles <- quantile(full_acs$pct_hispanic_pop_2011E, na.rm = TRUE)
pct_renter_2011_quartiles <- quantile(full_acs$pct_renter_2011E, na.rm = TRUE)
med_income_2011_quartiles <- quantile(full_acs$med_income_2011E, na.rm = TRUE)
```

```{r}
pct_pop_change_st_dev <- sd(full_acs$pct_pop_changeE, na.rm = TRUE)
pct_black_pop_2011_st_dev <- sd(full_acs$pct_black_pop_2011E, na.rm = TRUE)
pct_white_pop_2011_st_dev <- sd(full_acs$pct_white_pop_2011E, na.rm = TRUE)
pct_asian_pop_2011_st_dev <- sd(full_acs$pct_asian_pop_2011E, na.rm = TRUE)
pct_hispanic_pop_2011_st_dev <- sd(full_acs$pct_hispanic_pop_2011E, na.rm = TRUE)
pct_renter_2011_st_dev <- sd(full_acs$pct_renter_2011, na.rm = TRUE)
med_income_2011_st_dev <- sd(full_acs$med_income_2011E, na.rm = TRUE)
```

```{r}
pct_pop_change_hist <- ggplot(full_acs) +
  geom_histogram(aes(x = pct_pop_changeE),
                 bins = 30)

pct_black_pop_2011_hist <- ggplot(full_acs) +
  geom_histogram(aes(x = pct_black_pop_2011E),
                 bins = 30)

pct_white_pop_2011_hist <- ggplot(full_acs) +
  geom_histogram(aes(x = pct_white_pop_2011E),
                 bins = 30)

pct_asian_pop_2011_hist <- ggplot(full_acs) +
  geom_histogram(aes(x = pct_asian_pop_2011E),
                 bins = 30)

pct_hispanic_pop_2011_hist <- ggplot(full_acs) +
  geom_histogram(aes(x = pct_hispanic_pop_2011E),
                 bins = 30)

pct_renter_2011_hist <- ggplot(full_acs) +
  geom_histogram(aes(x = pct_renter_2011E),
                 bins = 30)

med_income_2011_hist <- ggplot(full_acs) +
  geom_histogram(aes(x = med_incomeE),
                 bins = 30)



pct_pop_change_hist
```

### References  

Faber, Jacob William. “Superstorm Sandy and the Demographics of Flood Risk in New York City.” *Human Ecology* 43, no. 3 (2015): 363–78. http://www.jstor.org/stable/24762762.

Fussell, Elizabeth, and Elizabeth Harris. “Homeownership and Housing Displacement after Hurricane Katrina among Low-Income African-American Mothers in New Orleans.” *Social Science Quarterly* 95, no. 4 (2014): 1086-1100. doi:10.1111/ssqu.12114. 

United States Census Bureau. American Community Survey, 5-year estimates. 2011-2016.

